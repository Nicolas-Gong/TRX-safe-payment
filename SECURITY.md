# 安全架构设计说明 (SECURITY.md)

TRX Safe Payment 的设计核心是“不信任任何中间环节”。我们实施了从存储到传输、从逻辑到交互的全方位防护。

## 1. 存储安全 (At-Rest Security)

### 私钥加密
- **不持久化明文**：私钥在任何时候都不会以明文形式存储在磁盘上。
- **高级加密**：采用 `androidx.security:security-crypto` 套件，利用硬件支持的 Android Keystore 进行主密钥生成和管理。
- **物理隔离**：观察钱包（Watch-Only）完全物理隔离私钥，仅存储公开的 Base58 地址。

### 配置存储
- 所有的单价、倍率和收款地址均通过加密存储，防止恶意应用修改 SharedPreferences 篡改收款参数。

## 2. 交互安全 (Interface Security)

### 人机交互验证
- **长按确认机制**：核心转账按钮（Dialog 中的确认按钮）必须长按 3 秒以上。这不仅是防止误触，更重要的是通过物理时间的强制等待，打破用户的“自动化点击”习惯，强制核对地址。
- **单价锁定**：设置页面的单价一旦锁定，必须通过生物识别验证才能解锁修改，防止他人在拿到解锁手机后篡改支付配置。

### 系统级锁定
- **超时锁定**：App 检测到进入后台超过预设时间（默认 1 分钟）后，会将应用状态置为 `LOCKED`。
- **生物识别**：集成 Android Biometric 框架，只有通过系统验证（指纹、面部或系统 PIN）才能重新进入界面或执行签名。

## 3. 交易安全 (On-Chain Security)

### 白名单验证 (RiskValidator)
- 每个转账操作都会由 `RiskValidator` 模块进行多重过滤：
    - **非白名单警告**：如果收款地址不在地址簿的白名单中，系统会弹出高级别危险警告。
    - **金额上限检查**：单次交易金额超过预设安全阈值时二次提示。

### 协议层限制 (SecurityConstraints)
- **代码级封禁**：在 `WalletManager` 和 `TransactionBuilder` 中强行硬编码过滤。
- **拒绝合约调用**：系统通过解析 `Transaction.rawData` 深度验证 `ContractType`。如果检测到 `TriggerSmartContract` 或 `SmartContract` 相关操作，将无条件拦截，杜绝恶意 DApp 的无限授权风险。
- **禁止 Data 字段**：防止交易中携带任何可能被合约解析的恶意 Payload。

## 4. 冷热分离流程

### 二维码分片传输 (QRSplitter)
为了保证冷钱包的绝对离线，我们设计了分片二维码协议。
- **离线签名**：热钱包生成待签名交易报文 -> 编码为二维码分片 -> 冷钱包扫描并重建逻辑 -> 离线签名 -> 生成已签名二维码分片 -> 热钱包扫描广播。
- **数据完整性**：每一片二维码都包含版本号、索引及总片数，确保扫码过程中数据的 100% 还原，防止通过修改部分二维码信息实现的中间人攻击。

## 5. 安全代码规范

- **无 Log 输出**：Release 版本中彻底移除所有涉及地址、交易哈希或配置信息的 Log 输出。
- **ProGuard 混淆**：核心加密逻辑及 RPC 通信类经过深度混淆，增加逆向工程成本。
- **防备份设置**：Manifest 中显式禁用 `android:allowBackup`。
